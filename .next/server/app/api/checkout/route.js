(()=>{var e={};e.id=146,e.ids=[146],e.modules={1708:e=>{"use strict";e.exports=require("node:process")},3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},7066:e=>{"use strict";e.exports=require("node:tty")},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},16698:e=>{"use strict";e.exports=require("node:async_hooks")},28354:e=>{"use strict";e.exports=require("util")},29021:e=>{"use strict";e.exports=require("fs")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},31421:e=>{"use strict";e.exports=require("node:child_process")},33873:e=>{"use strict";e.exports=require("path")},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},48161:e=>{"use strict";e.exports=require("node:os")},51455:e=>{"use strict";e.exports=require("node:fs/promises")},55511:e=>{"use strict";e.exports=require("crypto")},55591:e=>{"use strict";e.exports=require("https")},56324:(e,r,t)=>{"use strict";t.r(r),t.d(r,{patchFetch:()=>f,routeModule:()=>x,serverHooks:()=>y,workAsyncStorage:()=>h,workUnitAsyncStorage:()=>q});var s={};t.r(s),t.d(s,{POST:()=>m});var i=t(96559),o=t(48088),a=t(37719),n=t(32190),u=t(97877),c=t(85663);async function p(e){return await c.Ay.hash(e,10)}var d=t(79464);let l=new u.A(process.env.STRIPE_SECRET_KEY,{apiVersion:"2024-04-10"});async function m(e){try{let{customer:r,items:t}=await e.json();for(let e of t){let r=await d.z.productVariant.findUnique({where:{id:BigInt(e.variantId)},include:{product:!0}});if(!r)return n.NextResponse.json({error:`Product variant ${e.variantId} not found.`},{status:400});if(r.stockQty<e.quantity)return n.NextResponse.json({error:`Insufficient stock for ${r.product.name} (SKU: ${r.sku})`},{status:400});if(Number(r.price)!==Number(e.price))return n.NextResponse.json({error:`Price mismatch for ${r.product.name}. Please refresh your cart.`},{status:400})}let s=await d.z.user.findUnique({where:{email:r.email}});!s&&r.phone&&(s=await d.z.user.findUnique({where:{phone:r.phone}})),s||(s=await d.z.user.create({data:{email:r.email,phone:r.phone,name:r.fullName,password:r.password?await p(r.password):void 0}}));let i=await d.z.order.create({data:{userId:s.id,status:"PENDING",total:t.reduce((e,r)=>e+r.price*r.quantity,0),address:[r.address1,r.address2].filter(Boolean).join(", "),note:"",items:{create:await Promise.all(t.map(async e=>{let r=await d.z.productVariant.findUnique({where:{id:BigInt(e.variantId)},include:{product:!0}});if(!r)throw Error(`Product variant ${e.variantId} not found.`);let t=r.product.brandId&&await d.z.brand.findUnique({where:{id:r.product.brandId}}),s=r.product.categoryId&&await d.z.category.findUnique({where:{id:r.product.categoryId}});return{productId:r.productId,variantId:r.id,name:r.product.name,sku:r.sku,price:r.price,quantity:e.quantity,imageUrl:r.imageUrl,options:e.options,brand:t&&"object"==typeof t&&"name"in t?t.name:null,category:s&&"object"==typeof s&&"name"in s?s.name:null}}))}},include:{items:!0}}),o=await l.checkout.sessions.create({payment_method_types:["card"],line_items:i.items.map(e=>({price_data:{currency:"lkr",product_data:{name:e.name,description:Array.isArray(e.options)?e.options.map(e=>"object"==typeof e&&null!==e&&"optionName"in e?`${e.optionName}: ${e.value}`:"").join(", "):"",images:e.imageUrl?[e.imageUrl]:[]},unit_amount:Math.round(100*Number(e.price))},quantity:e.quantity})),mode:"payment",success_url:`${process.env.BASE_URL_NO_API}/success?session_id={CHECKOUT_SESSION_ID}`,cancel_url:`${process.env.BASE_URL_NO_API}/`,metadata:{orderId:i.id.toString(),userId:s.id.toString()}});return n.NextResponse.json({url:o.url,orderId:i.id.toString()})}catch(e){return console.error("Error in POST /api/checkout:",e),n.NextResponse.json({error:e instanceof Error?e.message:String(e)},{status:500})}}let x=new i.AppRouteRouteModule({definition:{kind:o.RouteKind.APP_ROUTE,page:"/api/checkout/route",pathname:"/api/checkout",filename:"route",bundlePath:"app/api/checkout/route"},resolvedPagePath:"C:\\nextjs\\e-commerce-store\\my-app\\app\\api\\checkout\\route.ts",nextConfigOutput:"",userland:s}),{workAsyncStorage:h,workUnitAsyncStorage:q,serverHooks:y}=x;function f(){return(0,a.patchFetch)({workAsyncStorage:h,workUnitAsyncStorage:q})}},57975:e=>{"use strict";e.exports=require("node:util")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},73024:e=>{"use strict";e.exports=require("node:fs")},76760:e=>{"use strict";e.exports=require("node:path")},77598:e=>{"use strict";e.exports=require("node:crypto")},78335:()=>{},78474:e=>{"use strict";e.exports=require("node:events")},79646:e=>{"use strict";e.exports=require("child_process")},81630:e=>{"use strict";e.exports=require("http")},94735:e=>{"use strict";e.exports=require("events")},96487:()=>{}};var r=require("../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),s=r.X(0,[4243,580,7877,5663,9464],()=>t(56324));module.exports=s})();